---
title: "BMIN503_FinalProject_Kanakamedala"
format: html
editor: visual
---

## Abstract

Pediatric headache is a common primary care complaint, yet referrals to neurology vary widely across clinicians and sites. A standardized SmartForm was deployed to structure documentation of red-flag symptoms and guide appropriate referral decisions. This project evaluates whether a derived red-flag scoring system aligns with actual clinical behavior and whether SmartForm usage may reduce unnecessary referrals while identifying encounters requiring expedited specialty care. Using 1,451 headache encounters from a large pediatric primary care network, we constructed a severity score using SmartForm red flags and mapped scores to recommended actions. We compared these recommendations to provider actions and fit logistic regression models to assess predictors of referral. Results show that the SmartForm is highly concordant for low-risk encounters, but overestimates the need for expedited referrals, which clinicians follow only 11.6% of the time. Findings indicate the need for score recalibration to improve clinical decision support.

## Introduction

Headache is one of the most frequent complaints in pediatric primary care. While the majority of cases are benign, identifying neurologic emergencies or high-risk conditions is essential. Unfortunately, headache referrals to neurology clinics are often inconsistent and not always aligned with evidence-based red-flag criteria. Excessive referrals contribute to long wait times, whereas under-referral can delay diagnosis of serious conditions.

To address this challenge, a standardized Headache SmartForm was introduced across a large pediatric network to structure documentation and guide decision-making. The SmartForm captures “red flag” symptoms in discrete fields, making it possible to generate automated decision support recommendations.

In this project, I used routinely collected SmartForm data from 1,451 headache encounters to construct a red-flag severity score, map scores to recommended actions (primary care management, standard neurology referral, expedited neurology referral), and compare these recommendations with actual provider behavior. I performed descriptive analyses, concordance analyses, and logistic regression models to (1) quantify overall neurology referral patterns, (2) estimate agreement between the score and clinician decisions, and (3) assess how severe and minor red flags predict referral and concordance across sites.

This final project evaluates whether a derived red-flag scoring system based on SmartForm inputs:

1.  Aligns with actual clinician referral behavior

2.  Appropriately stratifies severity

3.  Supports primary care management when appropriate

4.  Identifies cases requiring standard or expedited neurology referral

## Methods

### 1.1 Data Source

The dataset includes 1,451 headache encounters from CHOP primary care providers who used the SmartForm. Variables include:

-   Encounter metadata (date, department)

-   SmartForm red-flag indicators

-   Neurology referral actions (standard, expedited)

-   SmartForm usage (SMF_IND)

This structured documentation makes it possible to derive a reproducible triage scoring system.

### 1.2 Data Cleaning

We followed the structured approach shown in the example final project:

1.  **Clean and normalize column names**

2.  **Convert encounter dates** to usable date formats

3.  **Replace missing referral indicators with 0**, as absence of order indicates “not placed”

4.  **Create consolidated variables** for any referral and expedited referral

5.  **Construct red-flag scoring variables**

We treated missing values in \*\_ind variables as 0 because these fields correspond to discrete SmartForm selections; an unchecked option in the form indicates that the symptom was not present. We also consolidated referral indicators into “any_neuro_referral”, “standard_referral”, and “expedited_referral” to simplify interpretation and align our outcomes with operational referral categories.

```{r}
#| echo: true

# Load required libraries ----
library(tidyverse)
library(readr)
library(lubridate)
library(janitor)
library(broom)

# Load data directly from a fixed path
ha_raw <- read_csv("/Users/kanakamedl/Desktop/HA Neuro Referrals (2).csv")

# Clean variable names
ha <- ha_raw |> clean_names()

# Convert and recode missing inidcator fields and create referral outcome variables
ha <- ha |>
  mutate(
    encounter_date = mdy(encounter_date),
    across(ends_with("_ind"), ~replace_na(., 0)),
    any_neuro_referral = referral_neuro_ind == 1,
    standard_referral = standardreferral_ind == 1,
    expedited_referral = expedited_ind == 1
  )

```

### 1.3 Creating the Red-Flag Severity Score

Following the clinical hierarchy of red flags:

-   **Severe red flags (1000 points)**

    -   Persistent vomiting

    -   Persistent headache ≥ 2 weeks

These symptoms typically warrant urgent evaluation, justifying their large weight.

-   **Minor red flags (1 point)**

    -   Awakens from sleep

    -   Weight loss

    -   Unsteady gait
        Back-of-head headache

    -   Age ≤ 6

Recommendations were mapped as follows (reflecting the logic in the problem description):

| Score | Meaning                | CDS Recommendation      |
|-------|------------------------|-------------------------|
| 0     | No concerning findings | Primary care management |
| 1–2   | Moderate concern       | Standard referral       |
| ≥3    | High risk              | Expedited referral      |

```{r}
#| echo: true

#Construct severe and minor red flag components and total Smartform score
ha <- ha |>
mutate(
rf_persistent_vomiting = if_else(persistent_vomiting_ind == 1, 1000, 0),
rf_persistent_headache = if_else(continuous_two_weeks_ind == 1, 1000, 0),
rf_minor = ha_back_head_ind + unsteady_gait_ind +
weightloss_ind + awakes_from_sleep_ind + sixoryounger_ind,
redflag_score = rf_persistent_vomiting + rf_persistent_headache + rf_minor,
recommended_action = case_when(
redflag_score == 0 ~ "Primary care management recommended",
redflag_score %in% c(1, 2) ~ "Standard neurology referral recommended",
redflag_score >= 3 ~ "Expedited referral recommended"
)
)

```

### 1.4 Categorizing Actual Provider Behavior

```{r}
#| echo: true
#Create categorical variable representing actual clinician referral decisions
ha <- ha |>
mutate(
actual_action = case_when(
expedited_referral ~ "Expedited neurology referral placed",
standard_referral ~ "Standard neurology referral placed",
!any_neuro_referral ~ "No neurology referral placed",
TRUE ~ "Other/unclear"
)
)

```

### 1.5 Concordance Variable

```{r}
#| echo: true
#Define concordant = clinician action matches SmartForm recommendation
ha <- ha |>
mutate(
concordant = case_when(
recommended_action == "Primary care management recommended" &
actual_action == "No neurology referral placed" ~ 1,
recommended_action == "Standard neurology referral recommended" &
actual_action == "Standard neurology referral placed" ~ 1,
recommended_action == "Expedited referral recommended" &
actual_action == "Expedited neurology referral placed" ~ 1,
TRUE ~ 0
)
)

```

## Results

### 1.1 Overall Referral Patterns

```{r}
#| echo: true
overall_ref <- ha |>
count(actual_action) |>
mutate(pct = n / sum(n))

overall_ref

```

A majority of encounters (76.9%) did not result in a neurology referral. Standard and expedited referrals were used in 12.0% and 11.1% of encounters, respectively. This baseline is essential for interpreting SmartForm effectiveness.

### 1.2 Recommended vs. Actual Referral Behavior

```{r}
#| echo: true
#Cross-tab of Smartform recommendations vs. actual provider actions
rec_vs_actual <- ha |>
tabyl(recommended_action, actual_action) |>
adorn_percentages("row") |>
adorn_pct_formatting(digits = 1)

rec_vs_actual

```

The SmartForm accurately identifies low-risk children, with 75.8% concordance when recommending primary care management. However, when recommending expedited referral, providers only agreed in 11.6% of encounters, suggesting significant misalignment between scoring and clinician judgment.

### 1.3 Concordance Summary

```{r}
#| echo: true
ha |> summarise(overall_concordance = mean(concordant))

```

```{r}
#| echo: true
ha |> group_by(recommended_action) |>
summarise(
n = n(),
pct_concordant = mean(concordant)
)

```

### 1.4 Visualizations 

Figure 1: Stacked Bar Plot of Provider Actions vs. Recommendations

```{r}
#| echo: true
ggplot(ha, aes(x = recommended_action, fill = actual_action)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Provider Actions vs SmartForm Recommendations",
    x = "SmartForm Recommendation",
    y = "Proportion",
    fill = "Actual Action"
  ) +
  theme_minimal()

```

Figure 2: Overall Referral Proportions

```{r}
#| echo: true
ggplot(overall_ref, aes(x = actual_action, y = pct)) +
geom_col() +
scale_y_continuous(labels = scales::percent) +
labs(
title = "Overall Neurology Referral Patterns",
x = "",
y = "Percent of Encounters"
) +
theme_minimal()

```

Figure 3: Concordance Plot

```{r}
#| echo: true
concord_plot <- ha |>
group_by(recommended_action) |>
summarise(pct_concordant = mean(concordant))

ggplot(concord_plot, aes(x = recommended_action, y = pct_concordant)) +
geom_col() +
scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
labs(
title = "Concordance Between SmartForm Recommendations and Provider Behavior",
x = "Recommendation",
y = "Percent Concordant"
) +
theme_minimal()

```

## Modeling

For the modeling analyses, I treated expedited_referral and any_neuro_referral as primary outcomes because these represent key operational decisions for subspecialty access. Predictors included any_severe_flag (presence of persistent vomiting or persistent headache) and minor_flag_count (count of other pathway red flags). This reflects the clinical design of the SmartForm, where severe findings are expected to drive urgent action, and minor findings may refine risk without independently mandating referral.

### 1.1 Severe vs. Minor Red Flags: Predicting Expedited Referral

```{r}
#| echo: true
ha <- ha |> mutate(
any_severe_flag = if_else(rf_persistent_vomiting > 0 |
rf_persistent_headache > 0, 1, 0),
minor_flag_count = rf_minor
)

#Logistic regression: effect of severe and minor flags on Expedited referrals
model_expedited <- glm(
expedited_referral ~ any_severe_flag + minor_flag_count,
family = binomial,
data = ha
)

tidy(model_expedited, exponentiate = TRUE, conf.int = TRUE)

```

Severe flags show a borderline association with expedited referral (OR ≈ 8.4). Minor flags decrease the odds (OR ≈ 0.64), indicating clinicians do not expedite based on minor findings.

### 1.2 Predicting Any Referral

```{r}
#| echo: true
#Logistic regression: predictors of ANY neurology referral
model_anyref <- glm(
any_neuro_referral ~ any_severe_flag + minor_flag_count,
family = binomial,
data = ha
)

tidy(model_anyref, exponentiate = TRUE, conf.int = TRUE)

```

Severe symptoms strongly increase the likelihood of any referral (OR ≈ 12). Minor symptoms decrease it (OR ≈ 0.56).

### 1.3 Predicting Concordance

I modeled concordant as a binary outcome to quantify how often clinical behavior matched the score’s recommendation and used recommended_action as the predictor to compare agreement rates across primary care, standard, and expedited recommendation categories.

```{r}
#| echo: true
#Logistic regression: how SmartForm recommendations predicts clinician concordance
model_concord <- glm(
concordant ~ recommended_action,
family = binomial,
data = ha
)

tidy(model_concord, exponentiate = TRUE, conf.int = TRUE)

```

The SmartForm's expedited recommendation is rarely followed (OR = 0.042). Clinicians overwhelmingly override it.

# Discussion

This analysis demonstrates that a SmartForm-derived red-flag scoring system aligns well with clinical judgment in low-risk encounters but overestimates severity in moderate-to-high-risk cases. Clinicians agreed with primary care recommendations over 75% of the time, indicating strong utility in ruling out neurology referral.

However, the severe weighting system results in many encounters being labeled as needing expedited referral, despite clinicians choosing routine or no referral in nearly 90% of these cases. Regression analysis confirms that minor findings reduce referral odds, yet the scoring system treats them as additive risks.

These findings highlight the need to recalibrate the scoring thresholds, especially reducing severe flag weights and expanding the range for standard referrals.

# Conclusion

The SmartForm red-flag scoring system is effective for identifying low-risk pediatric headache encounters but performs poorly in distinguishing moderate from high risk. Providers rarely follow expedited recommendations, suggesting that the scoring system’s thresholds and weights require revision. Future iterations should incorporate clinician feedback and predictive modeling to refine decision support recommendations.

Specifically, in this dataset:

-   76.9% of headache encounters did not result in a neurology referral, and only 11.1% were expedited.

-   When the score recommended primary care management, clinicians agreed in \~70% of encounters, but when it recommended expedited referral, clinicians agreed in only \~12%.

-   Having any severe red flag increased the odds of any neurology referral by about 12-fold, while each additional minor flag decreased the odds of referral.
